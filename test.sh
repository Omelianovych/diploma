#!/bin/bash

echo "ðŸš€ [TRIGGER] ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸ÑŽ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹..."

# 1. OPENAT
# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð» Ñ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¼ Ð¸Ð¼ÐµÐ½ÐµÐ¼, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð»ÐµÐ³ÐºÐ¾ Ð½Ð°Ð¹Ñ‚Ð¸ Ð² Ð»Ð¾Ð³Ð°Ñ…
FILENAME="diploma_test_openat.txt"
echo "ðŸ”¹ [1] Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ OPENAT (touch $FILENAME)..."
touch $FILENAME
rm $FILENAME

sleep 0.5

# 2. EXECVE
# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ls Ñ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¼ Ñ„Ð»Ð°Ð³Ð¾Ð¼
echo "ðŸ”¹ [2] Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ EXECVE (ls -la)..."
ls -la /tmp >/dev/null

sleep 0.5

# 3. CONNECT
# ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ÑÑ Ðº Python-ÑÐµÑ€Ð²ÐµÑ€Ñƒ (ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ñ‚Ñ‹ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸ÑˆÑŒ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð¾)
# Ð­Ñ‚Ð¾ Ð²Ñ‹Ð·Ð¾Ð²ÐµÑ‚ CONNECT Ñƒ curl Ð¸ ACCEPT Ñƒ python3
TARGET="127.0.0.1:8000"
echo "ðŸ”¹ [3] Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ CONNECT (curl -> $TARGET)..."
curl -s http://$TARGET >/dev/null

echo "âœ… [TRIGGER] Ð“Ð¾Ñ‚Ð¾Ð²Ð¾."

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ strace
if ! command -v strace &>/dev/null; then
  echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: ÑƒÑ‚Ð¸Ð»Ð¸Ñ‚Ð° 'strace' Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°."
  echo "   Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ ÐµÑ‘: sudo apt install strace"
  exit 1
fi

# --- Ð¢Ð•Ð¡Ð¢ 1: PTRACE_TRACEME ---
echo ""
echo "[1] Ð—Ð°Ð¿ÑƒÑÐº 'strace ls' (PTRACE_TRACEME)..."
echo "    Ð­Ñ‚Ð¾ ÑÐ¸Ð¼ÑƒÐ»Ð¸Ñ€ÑƒÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ñ‹ Ð¿Ð¾Ð´ Ð¾Ñ‚Ð»Ð°Ð´Ñ‡Ð¸ÐºÐ¾Ð¼."
# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ls Ð¿Ð¾Ð´ strace, Ð¿Ð¾Ð´Ð°Ð²Ð»ÑÑ Ð²Ñ‹Ð²Ð¾Ð´ ÑÐ°Ð¼Ð¾Ð¹ ls Ð¸ strace
strace ls >/dev/null 2>&1
echo "âœ… Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¾."

sleep 2

# --- Ð¢Ð•Ð¡Ð¢ 2: PTRACE_ATTACH ---
echo ""
echo "[2] Ð¢ÐµÑÑ‚ Ð°Ñ‚Ð°ÐºÐ¸ Ð½Ð° Ð¶Ð¸Ð²Ð¾Ð¹ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ (PTRACE_ATTACH)..."

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ-Ð¶ÐµÑ€Ñ‚Ð²Ñƒ Ð² Ñ„Ð¾Ð½Ðµ
sleep 20 &
TARGET_PID=$!
echo "    ðŸŽ¯ Ð—Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ-Ð¶ÐµÑ€Ñ‚Ð²Ð° (sleep) Ñ PID: $TARGET_PID"

echo "    âš”ï¸  ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð¿Ñ€Ð¸Ñ†ÐµÐ¿Ð¸Ñ‚ÑŒÑÑ Ðº PID $TARGET_PID..."
# ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð¿Ñ€Ð¸Ñ†ÐµÐ¿Ð¸Ñ‚ÑŒÑÑ Ñ‡ÐµÑ€ÐµÐ· strace Ð½Ð° 2 ÑÐµÐºÑƒÐ½Ð´Ñ‹
# timeout Ð½ÑƒÐ¶ÐµÐ½, Ñ‡Ñ‚Ð¾Ð±Ñ‹ strace Ð½Ðµ Ð²Ð¸ÑÐµÐ» Ð²ÐµÑ‡Ð½Ð¾
timeout 2s strace -p $TARGET_PID >/dev/null 2>&1

echo "âœ… Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¾ (strace Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½)."

# Ð£Ð±Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ-Ð¶ÐµÑ€Ñ‚Ð²Ñƒ
kill $TARGET_PID 2>/dev/null
